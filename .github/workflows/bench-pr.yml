name: Benchmark PR
on:
  pull_request:
    branches: [main]
    paths: ['src/**', 'rseq/**', 'bench/**', 'Cargo.toml', 'Cargo.lock']

concurrency:
  group: bench-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: rustup show

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: bench-reg-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: bench-reg-

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # ---- base branch ----
      - run: git checkout ${{ github.event.pull_request.base.sha }}
      - run: cargo bench -p rstcmalloc-bench --bench alloc_bench -- --noplot
      - run: cp -r target/criterion target/criterion-base

      # ---- PR branch ----
      - run: git checkout ${{ github.event.pull_request.head.sha }}
      - run: rm -rf target/criterion
      - run: cargo bench -p rstcmalloc-bench --bench alloc_bench -- --noplot

      # ---- compare & comment ----
      - run: |
          python3 .github/scripts/extract-criterion.py \
            --base target/criterion-base \
            --head target/criterion \
            --output-comment bench-comment.md

      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmark-comparison
          path: bench-comment.md
